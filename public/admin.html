<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AndecoMarine.shop - Admin Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/admin.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <span class="logo-text">AndecoMarine.shop</span>
                </a>
                <nav class="nav">
                    <a href="index.html" class="nav-link">Home</a>
                    <a href="admin.html" class="nav-link active">Admin</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container container-full">
            <div class="admin-tabs">
                <button class="tab-btn active" data-tab="products">Products</button>
                <button class="tab-btn" data-tab="brands">Brands</button>
                <button class="tab-btn" data-tab="orders">Orders</button>
                <button class="tab-btn" data-tab="settings">Settings</button>
            </div>

            <!-- Products Tab -->
            <div id="productsTab" class="admin-tab-content active">
                <div class="admin-header">
                    <h2>Product Management</h2>
                    <button class="btn btn-primary" id="addProductBtn">+ Add New Product</button>
                </div>

                <div class="products-table-container">
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Brand</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <!-- Products will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Brands Tab -->
            <div id="brandsTab" class="admin-tab-content">
                <div class="admin-header">
                    <h2>Brand Management</h2>
                    <button class="btn btn-primary" id="addBrandBtn">+ Add New Brand</button>
                </div>

                <div class="brands-table-container">
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>Logo</th>
                                <th>Brand Name</th>
                                <th>Products</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="brandsTableBody">
                            <!-- Brands will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="ordersTab" class="admin-tab-content">
                <div class="admin-header">
                    <h2>Order Management</h2>
                </div>

                <div class="orders-table-container">
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Date</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Product</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Orders will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="admin-tab-content">
                <div class="admin-header">
                    <h2>Shop Settings</h2>
                </div>

                <div class="settings-container">
                    <div class="settings-section">
                        <h3>Shop Logo</h3>
                        <p class="settings-description">Add your shop logo. The logo will appear to the left of "AndecoMarine.shop" text in the header of all pages. You can use a URL or a local file path (e.g., "images/logo.png").</p>
                        
                        <form id="logoForm" class="settings-form">
                            <div class="form-group">
                                <label for="shopLogoUrl">Logo URL or File Path</label>
                                <input type="text" id="shopLogoUrl" placeholder="images/logo.png or https://example.com/logo.png" class="form-input">
                                <small>Enter the URL (https://...) or relative path to your logo image (e.g., "images/logo.png", "assets/logo.svg")</small>
                            </div>
                            
                            <div class="logo-preview" id="logoPreview" style="display: none;">
                                <p><strong>Preview:</strong></p>
                                <div class="logo-preview-container">
                                    <a href="#" class="logo">
                                        <span class="logo-text">AndecoMarine.shop</span>
                                    </a>
                                </div>
                                <p style="margin-top: 0.5rem; color: var(--text-light); font-size: 0.875rem;">Logo appears on the left, text on the right</p>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Save Logo</button>
                                <button type="button" class="btn btn-secondary" id="removeLogoBtn">Remove Logo</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Brand Modal -->
    <div id="brandModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="brandModalTitle">Add Brand</h3>
                <button class="modal-close" id="closeBrandModal">&times;</button>
            </div>
            <form id="brandForm" class="product-form">
                <input type="hidden" id="brandId">
                
                <div class="form-group">
                    <label for="brandName">Brand Name *</label>
                    <input type="text" id="brandName" required>
                </div>

                <div class="form-group">
                    <label for="brandLogo">Brand Logo URL *</label>
                    <input type="text" id="brandLogo" placeholder="https://example.com/logo.png" required>
                    <small>Enter the URL of the brand logo image</small>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelBrandBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Brand</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add Product</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <form id="productForm" class="product-form">
                <input type="hidden" id="productId">
                
                <div class="form-group">
                    <label for="productName">Product Name *</label>
                    <input type="text" id="productName" required>
                </div>

                <div class="form-group">
                    <label for="productCategory">Brand *</label>
                    <select id="productCategory" required>
                        <option value="">Select a brand...</option>
                        <!-- Brands will be loaded here -->
                    </select>
                    <small>Select the product brand from the list</small>
                </div>

                <div class="form-group">
                    <label for="productPrice">Base Price *</label>
                    <input type="number" id="productPrice" step="0.01" min="0" required>
                </div>

                <div class="form-group">
                    <label for="productStock">Stock Quantity *</label>
                    <input type="number" id="productStock" min="0" required>
                </div>

                <div class="form-group">
                    <label for="productDescription">Description *</label>
                    <textarea id="productDescription" rows="4" required></textarea>
                </div>

                <div class="form-group">
                    <label for="productStandardEquipment">Standard Equipment (included in base price)</label>
                    <textarea id="productStandardEquipment" rows="6" placeholder="Accessories:&#10;- USB-C cable&#10;- Carrying case&#10;&#10;Documentation:&#10;- User manual&#10;- Warranty card"></textarea>
                    <small>Enter groups with headers. Format: "Header Name:" followed by items starting with "-". Leave a blank line between groups.</small>
                </div>

                <div class="form-group">
                    <label for="productSpecs">Specifications (JSON format)</label>
                    <textarea id="productSpecs" rows="4" placeholder='{"Color": "Red", "Size": "Large", "Weight": "2kg"}'></textarea>
                    <small>Enter specifications as JSON key-value pairs</small>
                </div>

                <div class="form-group">
                    <label for="productImages">Images (comma-separated URLs) *</label>
                    <input type="text" id="productImages" placeholder="https://example.com/image1.jpg, https://example.com/image2.jpg" required>
                    <small>Enter image URLs separated by commas</small>
                </div>

                <div class="form-group">
                    <label for="productPdfPhoto">PDF Photo (for order PDFs)</label>
                    <input type="file" id="productPdfPhoto" accept="image/*">
                    <small>Upload a photo that will be included in order PDFs. If not provided, the first product image will be used.</small>
                    <div id="pdfPhotoPreview" style="margin-top: 0.5rem; display: none;">
                        <img id="pdfPhotoPreviewImg" src="" alt="PDF Photo Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid var(--border-color);">
                        <button type="button" id="removePdfPhoto" class="btn btn-secondary btn-small" style="margin-left: 0.5rem; margin-top: 0.5rem;">Remove</button>
                    </div>
                    <small>Enter image URLs separated by commas</small>
                </div>

                <div class="form-group">
                    <label>Additional Options</label>
                    <div id="optionsContainer">
                        <!-- Options will be added here -->
                    </div>
                    <button type="button" class="btn btn-secondary" id="addOptionBtn">+ Add Option</button>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Product</button>
                </div>
            </form>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 AndecoMarine.shop. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module">
        // Check authentication before loading admin
        import { isAdminAuthenticated } from './js/api.js';
        
        if (!isAdminAuthenticated()) {
            window.location.href = 'login.html';
        } else {
            // Load data.js first (must be loaded before admin.js)
            const dataScript = document.createElement('script');
            dataScript.src = 'js/data.js';
            document.body.appendChild(dataScript);
            
            // Load image-proxy.js
            const imageProxyScript = document.createElement('script');
            imageProxyScript.src = 'js/image-proxy.js';
            document.body.appendChild(imageProxyScript);
            
            // Load api.js
            const script1 = document.createElement('script');
            script1.src = 'js/api.js';
            script1.type = 'module';
            document.head.appendChild(script1);
            
            // Load nav.js
            const script2 = document.createElement('script');
            script2.src = 'js/nav.js';
            document.body.appendChild(script2);
            
            // Load admin.js after data is initialized
            dataScript.onload = () => {
                console.log('data.js loaded, waiting for data initialization...');
                
                // Wait for data initialization
                const waitForData = () => {
                    // Check if admin.js is already loaded
                    if (document.querySelector('script[src*="admin.js"]')) {
                        console.log('admin.js already loaded, skipping');
                        return; // Already loaded, don't load again
                    }
                    
                    // Check if functions are available
                    if (typeof getProducts === 'function' && typeof getBrands === 'function') {
                        console.log('Functions available, loading admin.js...');
                        const script3 = document.createElement('script');
                        // Add cache busting
                        script3.src = 'js/admin.js?v=' + Date.now();
                        script3.onload = () => console.log('admin.js loaded successfully');
                        script3.onerror = (e) => console.error('Error loading admin.js:', e);
                        // Don't use module type - admin.js needs access to global functions
                        document.body.appendChild(script3);
                    } else {
                        console.log('Functions not available yet, waiting...', {
                            getProducts: typeof getProducts,
                            getBrands: typeof getBrands,
                            cacheInitialized: window.cacheInitialized
                        });
                        // Wait a bit more for functions to be available
                        setTimeout(waitForData, 100);
                    }
                };
                
                // Wait for data to be initialized
                if (window.cacheInitialized && typeof getProducts === 'function') {
                    console.log('Data already initialized, loading admin.js immediately');
                    waitForData();
                } else {
                    console.log('Waiting for dataLoaded event...');
                    window.addEventListener('dataLoaded', () => {
                        console.log('dataLoaded event received');
                        waitForData();
                    }, { once: true });
                    // Also try after a short delay
                    setTimeout(() => {
                        console.log('Timeout check - cacheInitialized:', window.cacheInitialized);
                        waitForData();
                    }, 500);
                    // Fallback timeout
                    setTimeout(() => {
                        if (!document.querySelector('script[src*="admin.js"]')) {
                            console.log('Fallback timeout - forcing admin.js load');
                            waitForData();
                        }
                    }, 5000);
                }
            };
            
            // Also handle if data.js loads but onload doesn't fire
            setTimeout(() => {
                if (!document.querySelector('script[src*="admin.js"]') && typeof getProducts === 'function') {
                    console.log('Fallback: Loading admin.js after timeout');
                    const script3 = document.createElement('script');
                    script3.src = 'js/admin.js?v=' + Date.now();
                    document.body.appendChild(script3);
                }
            }, 2000);
        }
    </script>
</body>
</html>
